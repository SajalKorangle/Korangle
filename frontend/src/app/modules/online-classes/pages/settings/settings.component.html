<div class="card-content" *ngIf="!isLoading else MainLoader">
    <div>
        <mat-form-field style="margin-right: 20px;">
            <mat-select placeholder="Select Class" [(ngModel)]="userInput.selectedClass"
                (ngModelChange)="htmlRenderer.initilizeTimeTable()">
                <mat-option *ngFor="let classs of backendData.classList" [value]="classs">
                    {{ classs.name }}
                </mat-option>
            </mat-select>
        </mat-form-field>

        <mat-form-field style="margin-right: 20px;">
            <mat-select placeholder="Select Section" [(ngModel)]="userInput.selectedSection"
                (ngModelChange)="htmlRenderer.initilizeTimeTable()">
                <mat-option *ngFor="let division of backendData.divisionList" [value]="division">
                    {{ division.name }}
                </mat-option>
            </mat-select>
        </mat-form-field>
    </div>

    <ng-container *ngIf="userInput.selectedClass && userInput.selectedSection">

        <h4>{{htmlRenderer.getClassDivisionName(userInput.selectedClass.id, userInput.selectedSection.id)}}</h4>

        <div style="overflow: auto;">
            <table class="mat-elevation-z8 table table-hover">
                <thead>
                    <tr>
                        <th></th>
                        <th *ngFor="let weekdayKey of getObjetKeys(weekdays)">{{weekdays[weekdayKey]}}</th>
                    </tr>
                </thead>
                <tbody>
                    <ng-container *ngFor="let timespan of htmlRenderer.timeSpanList, let timeSpanIndex = index;">
                        <tr>
                            <td style="width: 160px">
                                <ng-container
                                    *ngIf="htmlRenderer.editTimeSpanFormIndex!=timeSpanIndex else EditTimeSpanForm">
                                    {{timespan.startTime.getDisplayString()}} - {{timespan.endTime.getDisplayString()}}
                                    <mat-icon class="td-hover-show"
                                        (click)="htmlRenderer.editTimeSpanFormIndex=timeSpanIndex; htmlRenderer.setupEditTimeSpan()"
                                        style="font-size: small;">edit</mat-icon>
                                </ng-container>
                            </td>
                            <ng-container *ngFor="let weekday of getObjetKeys(weekdays), let i = index;">
                                <ng-container
                                    *ngIf="htmlRenderer.getOnlineClassByWeekDayAndTime(weekday, timespan) as onlineClass else NoClass;">
                                    <td style="position: relative; cursor: pointer;"
                                        (click)="htmlRenderer.openNewOnlineClassDalog(weekday, timespan)"
                                        [style.color]="htmlRenderer.colorPaletteHandle.getColorForSubject(htmlRenderer.getDisplayData(onlineClass).subject.name)"
                                        [style.backgroundColor]="htmlRenderer.colorPaletteHandle.getBackgroundColorForSubject(htmlRenderer.getDisplayData(onlineClass).subject.name)">

                                        <span>{{htmlRenderer.getDisplayData(onlineClass).subject.name}}</span><br />
                                        <span>({{htmlRenderer.getDisplayData(onlineClass).employee.name}})</span>

                                        <span *ngIf="onlineClass.meetingNumber"
                                            style="position: absolute; bottom: 8px; right: 8px;"
                                            class="glow-active"></span>

                                        <mat-icon class="td-hover-show hover-red"
                                            (click)="htmlRenderer.deleteOnlineClass(onlineClass); $event.stopPropagation()"
                                            style="position: absolute; font-size: small; top: 2px; right: -6px; ">delete
                                        </mat-icon>

                                    </td>
                                </ng-container>
                                <ng-template #NoClass>
                                    <td>
                                        <div>
                                            <button mat-stroked-button
                                                (click)="htmlRenderer.openNewOnlineClassDalog(weekday, timespan)">
                                                <mat-icon>add</mat-icon>
                                            </button>
                                        </div>
                                    </td>
                                </ng-template>
                            </ng-container>
                        </tr>
                    </ng-container>
                    <tr>
                        <td style="width: 200px">
                            <button mat-fab (click)="htmlRenderer.newTimeSpanForm = true;"
                                *ngIf="!htmlRenderer.newTimeSpanForm else NewTimeSpanForm">
                                <mat-icon>add</mat-icon>
                            </button>
                        </td>
                        <ng-container *ngFor="let weekday of getObjetKeys(weekdays)">
                            <td></td>
                        </ng-container>
                    </tr>
                </tbody>
            </table>
        </div>
        <mat-divider style="margin-top: 32px;"></mat-divider>
        <button class="btn btn-{{ user.activeSchool.secondaryThemeColor }}" style="float: right;"
            (click)="serviceAdapter.updateOnlineClassList();">Update</button>
    </ng-container>

</div>

<ng-template #MainLoader>
    <app-loading-spinner [user]="user"></app-loading-spinner>
</ng-template>

<ng-template #NewTimeSpanForm>
    <mat-form-field>
        <mat-label>Start Time</mat-label>
        <input matInput type="time" [errorStateMatcher]="{isErrorState: htmlRenderer.newTimeSpanError}"
            [(ngModel)]="userInput.newTimeSpan.startTime">
    </mat-form-field>
    <mat-form-field>
        <mat-label>End Time</mat-label>
        <input matInput [errorStateMatcher]="{isErrorState: htmlRenderer.newTimeSpanError}" type="time"
            [(ngModel)]="userInput.newTimeSpan.endTime">
        <mat-error *ngIf="htmlRenderer.endTimeBeforeStartTime()">End time before start time</mat-error>
        <mat-error *ngIf="htmlRenderer.timeSpanOverlapping()">Time Span Overlapping </mat-error>
    </mat-form-field>
    <button mat-stroked-button style="margin-top: 6px;"
        (click)="userInput.resetNewTimeSpanData(); htmlRenderer.newTimeSpanForm = false;">Cancel</button>
    <button mat-stroked-button [disabled]="htmlRenderer.newTimeSpanError()" style="margin-top: 6px;"
        (click)="htmlRenderer.addNewTimeSpan(); htmlRenderer.newTimeSpanForm = false;">Add</button>
</ng-template>


<ng-template #EditTimeSpanForm>
    <mat-form-field>
        <mat-label>Start Time</mat-label>
        <input matInput type="time" [errorStateMatcher]="{isErrorState: htmlRenderer.editTimeSpanError}"
            [(ngModel)]="userInput.newTimeSpan.startTime">
    </mat-form-field>

    <mat-form-field>
        <mat-label>End Time</mat-label>
        <input matInput [errorStateMatcher]="{isErrorState: htmlRenderer.editTimeSpanError}" type="time"
            [(ngModel)]="userInput.newTimeSpan.endTime">
        <mat-error *ngIf="htmlRenderer.endTimeBeforeStartTime()">End time before start time</mat-error>
        <mat-error *ngIf="htmlRenderer.timeSpanOverlapping()">Time Span Overlapping </mat-error>
    </mat-form-field>

    <button mat-stroked-button style="margin-top: 6px; margin-right: 6px;" (click)="htmlRenderer.deleteTimeSpan()">
        <mat-icon>delete</mat-icon>
    </button>
    <button mat-stroked-button [disabled]="htmlRenderer.newTimeSpanError()" style="margin-top: 6px;"
        (click)="htmlRenderer.editTimeSpan(); htmlRenderer.editTimeSpanForm = -1;">Update</button>
</ng-template>