<div class="card-content table-responsive" id="drc-wrapper" style="height: 90vh;" *ngIf="!htmlAdapter.isLoading; else spinner">

    <!-- Choose to add/edit/delete layout/s -->
    <mat-form-field style="margin-bottom: 10px;">
        <mat-select placeholder="Choose to add/edit/delete layout/s"
                    [ngModel]="currentLayout"
                    (ngModelChange)="populateCurrentLayoutWithGivenValue($event);">
            <mat-option [value]="ADD_LAYOUT_STRING">{{ADD_LAYOUT_STRING}}</mat-option>
            <mat-option *ngFor="let layout of reportCardLayoutList;" [value]="layout">{{layout.name}}</mat-option>
        </mat-select>
    </mat-form-field>

    <div id="drc-mainCard" style="margin:0; padding:0;" class="bg-white">
    <ng-container *ngIf="currentLayout">
    <mat-card>
        <div *ngIf="!htmlAdapter.isFullScreen">
        <mat-form-field style="width: 100%; max-width: 250px;">
            <mat-label>
                Layout Name
            </mat-label>
            <input matInput [(ngModel)]="currentLayout.name">
            <mat-icon matSuffix *ngIf="doesCurrentLayoutHasUniqueName()"><span class="matrial-icons">emoji_emotions</span></mat-icon>
            <mat-hint style="color:red; display: block;" *ngIf="!doesCurrentLayoutHasUniqueName() && currentLayout.name!=''" class="small">
                Layout name must be unique
            </mat-hint>
        </mat-form-field>

        <button *ngIf="currentLayout.id"
                class="btn material-icons"
                (click)="serviceAdapter.deleteCurrentLayout()"
                style="padding: 4px 7px; margin-right: 12px; float: right;">delete</button>

        <button class="btn"
                (click)="resetCurrentLayout()"
                style="padding: 4px 7px; margin-right: 12px; float: right;">Reset All</button>

        </div>

        
        <div *ngIf="htmlAdapter.isSaving" style="width: 100%; height: 100%; position: absolute; z-index: 1; backdrop-filter: blur(1px);"></div>
        
        <mat-card class="bg-grey flex-row" style="width: 100%; padding: 4px; margin-top: 6px; align-items: center;" [class.stickyTop]="htmlAdapter.isFullScreen">
            <!-- Top Toolbar -->

            <div class="tool" style="padding: 2px;"> <!--Background Color Picker-->   
                    <label>Background Color: </label>
                    <input type="color" [value]="canvasAdapter.backgroundColor" (input)="canvasAdapter.applyBackground($event.target.value)"/>
            </div>

            <div class="tool">
                <button class="btn material-icons"
                        (click)="canvasAdapter.addEmptyPage()">note_add</button>
            </div>

            <div class="tool">  <!--Add Image-->
                <input type='file' (change)="imageUploadHandler($event)" multiple="false" style="display: none" accept="image/x-png,image/jpeg" #imageInput/>
                <button class="btn material-icons"
                        (click)="imageInput.click()">add_photo_alternate</button>
            </div>

            <div class="tool">
                <button class="btn material-icons"
                        (click)="canvasAdapter.fullCanavsRefresh()" [disabled]="htmlAdapter.isSaving">refresh</button>
            </div>

            <div class="tool">
                <button class="btn material-icons"
                        (click)="htmlAdapter.fullScreenToggle()">{{htmlAdapter.isFullScreen?'fullscreen_exit':'fullscreen'}}</button>
            </div>

            <div class="tool">
                <button class="btn material-icons"
                        [disabled]="canvasAdapter.maximumCanvasSize() == true"
                        (click)="canvasAdapter.increaseCanvasSize()">zoom_in</button>    <!--To Be Implemented: Canavs resize-->
            </div>

            <div class="tool">
                <button class="btn material-icons"
                        [disabled]="canvasAdapter.minimumCanvasSize() == true"
                        (click)="canvasAdapter.decreaseCanvasSize()">zoom_out</button>    <!--To Be Implemented: Canavs resize-->
            </div>

            <div class="tool">
                <button class="btn material-icons"
                        (click)="canvasAdapter.duplicateLayer(canvasAdapter.activeLayer)">content_copy</button>
            </div>

            <div class="tool">
                <button class="btn material-icons"
                        (click)="canvasAdapter.downloadPDF()">save_alt</button>
            </div>

            <div class="tool">
                <button class="btn material-icons"
                        (click)="canvasAdapter.newTextLayer()">title</button>
            </div>

            <div class="tool">
                <button class="btn material-icons"
                        (click)="canvasAdapter.newDateLayer()">calendar_today</button>
            </div>

            <div class="tool">
                <button class="btn material-icons"
                        (click)="logMessage('table added')"
                        mat-button [matMenuTriggerFor]="tableMenu" >backup_table</button>
                <mat-menu #tableMenu="matMenu">
                    <div style="display: flex; flex-direction: column; margin: 4px 12px;" (click)="canvasAdapter.newTableLayer({rowCount: htmlAdapter.newTableRowCount, columnCount: htmlAdapter.newTableColumnCount})">
                        <div style="width: 100%; display: flex; flex-direction: row;justify-content: space-between;"
                                *ngFor="let row of htmlAdapter.getArrayOfLength(htmlAdapter.tableToolbarAssistanceRowCount);">
                            <ng-container *ngFor="let col of htmlAdapter.getArrayOfLength(htmlAdapter.tableToolbarAssistanceColumnCount);">
                                <span style="height: 10px; width: 10px;; margin: 1px"
                                    [style.backgroundColor]="row<=htmlAdapter.newTableRowCount&&col<=htmlAdapter.newTableColumnCount?'blue':'lightgrey'"
                                    (mouseover)="htmlAdapter.newTableColumnCount = col; htmlAdapter.newTableRowCount=row;">
                                </span>
                            </ng-container>
                        </div>
                    </div>
                </mat-menu>
            </div>

            <div class="tool">
                <button class="btn" style="padding: 8px;"
                        (click)="htmlAdapter.openCustomVariableDialog(canvasAdapter.newFormulaLayer())">FORMULA</button>
            </div>

            <div class="tool">
                <button class="btn" style="padding: 8px;"
                        (click)="htmlAdapter.openGradeRulesDialog()">Grade Rules</button>
            </div>

            <div class="tool">
                <button class="btn material-icons"
                        (click)="htmlAdapter.openPageResolutionDialog()">photo_size_select_large</button>
            </div>

            <div class="tool" style="margin-left: auto;">
                <mat-form-field style="width: 50px; height: 30px;">
                <mat-select placeholder="DPI" [(ngModel)]="canvasAdapter.dpi">
                    <mat-option *ngFor="let dpi of htmlAdapter.dpiList" [value]="dpi">{{dpi}}</mat-option>
                </mat-select>
                </mat-form-field>
            </div>

        </mat-card>




        <div class="flex-row" style="margin-top: 8px; width: 100%; height: calc(100vh - 90px); justify-content: space-between; position: relative;" id="canvasDesigningWrapper">

            <!--Custom Context Menu-->
            <ng-container *ngIf="htmlAdapter.customMenuDisplay">
                <app-custom-menu [left]="htmlAdapter.customMenuLeft"
                        [top]="htmlAdapter.customMenuTop"
                        [layer]="canvasAdapter.activeLayer" 
                        [ca]="canvasAdapter" 
                        [layerIndex]="canvasAdapter.activeLayerIndex"
                        (closeMenu)="htmlAdapter.closeContextMenu()">
                    </app-custom-menu>
            </ng-container>

            <!-- column1: Left Pannel -->
            <mat-card class="inline-block" style="width: 240px; padding: 4px;" class="leftPannel bg-grey">
                <mat-button-toggle-group style="width: 100%; margin-top: 2px;">
                    <mat-button-toggle value="layers" [checked]="htmlAdapter.activeLeftColumn === 'layers'"  (click)="htmlAdapter.activeLeftColumn = 'layers'">Layers</mat-button-toggle>
                    <mat-button-toggle value="parameters" (click)="htmlAdapter.activeLeftColumn = 'parameters'">Parameters</mat-button-toggle>
                </mat-button-toggle-group>


                <!-- Parameters -->
                <ng-container *ngIf="htmlAdapter.activeLeftColumn === 'parameters'">
                <div style="padding: 4px; border-radius: 4px; text-align: center;" class="bg-white inner-content">
                   
                <ng-container *ngFor="let fieldKey of htmlAdapter.getFieldKeys(); let i = index;">
                    <mat-form-field style="margin-bottom: 1vh;">
                        <mat-label>
                            {{htmlAdapter.fields[fieldKey].displayFieldName}}
                        </mat-label>
                        <mat-select [value]="null">
                            <mat-option *ngFor="let parameter of htmlAdapter.getFilteredParameterList(htmlAdapter.fields[fieldKey])"
                                    (click)="htmlAdapter.addNewLayerForAsset(parameter)">
                                {{parameter.displayParameterNameFunc()}}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </ng-container>
                <mat-form-field>
                    <mat-label>Result</mat-label>
                    <mat-select [value]="null">
                        <mat-option (click)="htmlAdapter.openResultDialog(canvasAdapter.newReultLayer())">Pass/Fail/Supplementary</mat-option>
                    </mat-select>
                </mat-form-field>
                    
                </div>
                </ng-container>

                
                <!-- Layers Column -->
                <ng-container *ngIf="htmlAdapter.activeLeftColumn === 'layers'">
                    <div class="flex-column inner-content" style="flex-direction: column-reverse; position: relative; overflow: visible;">
                        <ng-container *ngFor="let layer of canvasAdapter.layers; index as i">
                            <hr style="margin:0; background-color: gray; height: 3px; display: none;" [id]="layer.id"/>
                            <span *ngIf="layer" draggable="true" 
                                    (dragover)="$event.preventDefault(); htmlAdapter.dropAssistanceDisplay(layer.id);"
                                    (dragleave)="htmlAdapter.dropAssistanceHide(layer.id)"
                                    (dragstart)="$event.target.style.opacity='0.5'; $event.dataTransfer.setData('layerId', layer.id);" 
                                    (dragend)="$event.target.style.opacity='1'"
                                    (drop)="$event.preventDefault(); canvasAdapter.layerMove(layer.id, $event.dataTransfer.getData('layerId')); htmlAdapter.dropAssistanceHide(layer.id);"
                                    (mousedown)="canvasAdapter.updateActiveLayer(i, $event);"
                                    (contextmenu)="$event.preventDefault(); htmlAdapter.openContextMenu($event);"
                                    style="width: calc(100% - 8px); text-align: center; margin: 4px; padding: 4px; border-radius: 3px; cursor: pointer; white-space: nowrap;" 
                                    [class]="i==canvasAdapter.activeLayerIndex?'bg-active':'bg-white'"> 
                                <span (blur)="layer.displayName=$event.target.innerText" style="display: inline-block;" contenteditable="true"> {{layer.displayName}} </span>   <!--this is layer name-->
                                <span style="float: right; margin-right: 12px;">#{{layer.id}}</span>   <!-- i is id which is the array index no.of layers -->
                            </span>
                        </ng-container>
                    </div>
                </ng-container>

            </mat-card>

            
            
            <!-- column 2: Canvas -->
            <mat-card class="bg-grey inline-block" style="padding:0; width: calc(100% - 510px); position: relative; text-align: center; overflow: auto;" id="canvasWrapper">
                <ng-container *ngIf="htmlAdapter.isSaving"><mat-progress-bar mode="indeterminate" style="position: absolute; z-index: 2;"></mat-progress-bar></ng-container>
                <div style="position: absolute; right: 2px; top: 4px; display: flex; flex-direction: column;" *ngIf="currentLayout.content.length>1">
                    <button *ngFor="let dummy of currentLayout.content; let ind = index;" 
                            (click)="canvasAdapter.updatePage(ind)"
                            [class]="'btn ' + (canvasAdapter.activePageIndex==ind?'bg-active':'bg-white')" 
                            style="padding: 4px 8px; margin: 3px;">
                        {{ind+1}}
                    </button>
                </div>
                <canvas id="mainCanvas" [style.margin.px]="htmlAdapter.canvasMargin"></canvas>
            </mat-card>


           
            <!-- column 3: Right Pannel -->
            <mat-card class="inline-block flex-column" style="width: 240px; padding-top: 8px; align-items: center; overflow-y: auto; overflow-x: hidden;">
                <span *ngIf="!canvasAdapter.activeLayer" style="margin-top: 25px;">No Layers Selected </span>
                
                <div *ngIf="canvasAdapter.activeLayer" class="parameters-tool" style="margin:0; width: 100%;">
                    <app-position-parameter-pannel
                            [layer]="canvasAdapter.activeLayer"
                            [canvasRefresh]="canvasAdapter.scheduleCanvasReDraw"
                            ></app-position-parameter-pannel>
                </div>

                <div *ngIf="canvasAdapter.activeLayer && canvasAdapter.activeLayer.parameterToolPannels.includes('text')" class="parameters-tool" style="margin:0; width: 100%;">
                    <app-text-parameters-pannel
                            [layer]="canvasAdapter.activeLayer"
                            [canvasRefresh]="canvasAdapter.scheduleCanvasReDraw"
                            ></app-text-parameters-pannel>
                </div>
                
                <div class="parameters-tool" style="margin:0; width: 100%;">
                    <app-image-parameters-pannel 
                            *ngIf="canvasAdapter.activeLayer && canvasAdapter.activeLayer.parameterToolPannels.includes('image')"
                            [layer]="canvasAdapter.activeLayer"
                            [canvasRefresh]="canvasAdapter.scheduleCanvasReDraw"
                            ></app-image-parameters-pannel>
                </div>

                <div *ngIf="canvasAdapter.activeLayer && canvasAdapter.activeLayer.parameterToolPannels.includes('attendance')" class="parameters-tool" style="margin:0; width: 100%;">
                    <app-attendance-parameters-pannel
                            [layer]="canvasAdapter.activeLayer"
                            [canvasRefresh]="canvasAdapter.scheduleCanvasReDraw"
                            ></app-attendance-parameters-pannel>
                </div>

                <div *ngIf="canvasAdapter.activeLayer && canvasAdapter.activeLayer.parameterToolPannels.includes('marks')" class="parameters-tool" style="margin:0; width: 100%;">
                    <app-marks-parameters-pannel 
                            [layer]="canvasAdapter.activeLayer"
                            [canvasRefresh]="canvasAdapter.scheduleCanvasReDraw"
                            ></app-marks-parameters-pannel>
                </div>

                <div *ngIf="canvasAdapter.activeLayer && canvasAdapter.activeLayer.parameterToolPannels.includes('formula')" class="parameters-tool" style="margin:0; width: 100%;">
                    <app-formula-parameters-pannel
                            [layer]="canvasAdapter.activeLayer"
                            [canvasRefresh]="canvasAdapter.scheduleCanvasReDraw"
                            ></app-formula-parameters-pannel>
                </div>
                <div *ngIf="canvasAdapter.activeLayer && canvasAdapter.activeLayer.parameterToolPannels.includes('result')" class="parameters-tool" style="margin:0; width: 100%; text-align: center;">
                    <button class="btn" style="padding: 8px;" (click)="htmlAdapter.openResultDialog(canvasAdapter.activeLayer)">Result Configuration</button>
                </div>

            </mat-card>

        </div>
    </mat-card>

    <div style="text-align: right; padding: 0;" *ngIf="!htmlAdapter.isFullScreen">   <!--Save Button-->
        <button class="btn btn-{{user.activeSchool.secondaryThemeColor}} material-icons"
                (click)="htmlAdapter.isSaving=true; saveLayout();" [disabled]="htmlAdapter.isSaving">save</button>
    </div>

    </ng-container>
    </div>


</div>

<ng-template #spinner>
    <app-loading-spinner [user]="user"></app-loading-spinner>
</ng-template>
