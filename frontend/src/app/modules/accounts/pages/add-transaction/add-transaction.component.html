<div class="card-content table-responsive" *ngIf="!isLoading">
    <div *ngIf="lockAccounts">
        <span  style="color: red;">
            <h4><b><i class="material-icons" style="vertical-align: -6px;">error_outline</i>
                All Accounts has been locked for this session . No further transctions can be added. </b></h4></span>
    </div>
    
    <div *ngIf="!lockAccounts">
    <div class="row col-md-12">
        <mat-form-field style="margin-top: 5px ; margin-right: 15px; margin-bottom: 5px; width: 150px">
            <input type="date" matInput
                onkeydown="return false"
                [min] ="minimumDate"
                [max] = "maximumDate"
                [ngModel]="selectedDate"
                (ngModelChange)="selectedDate=$event; func();" placeholder="Choose Date ">
        </mat-form-field>
    </div>

    <div *ngFor="let transaction of transactions; let i = index">
        <div class="row">
            <div class="col-md-1" style="width: 4%; margin-top: 15px">
                <strong>{{i+1}}.</strong>
            </div>
            <div class="col-md-4">
                <div *ngFor="let account of transaction.debitAccounts; let j = index">
                    <div class="row col-md-12">
                        <mat-form-field style="width: 100%;">
                            <mat-select placeholder="Pay To" [ngModel]="account.debitAccount"
                                (ngModelChange)="account.debitAccount = $event; account" [disabled]="transaction.approvalId != null">
                                <mat-option *ngFor="let account of accountsList"
                                    [value]="account">
                                    {{account.title}}&nbsp;A/c
                                </mat-option>   
                            </mat-select>
                        </mat-form-field>
                    </div>
                    <div class="row col-md-12" style="margin-top: -17px">
                        <span *ngIf="account.debitAccount != null" style="float: left; font-size: 11px; color:rgba(133, 133, 133, 1)">Current Balance - {{account.debitAccount.balance}} </span>
                        <span *ngIf="transaction.debitAccounts.length > 1" style="float: right; font-size: 13px; color: rgba(255, 152, 0, 1); cursor: pointer" (click)="removeDebitAccount(i, j); handleAmountChange(transaction)">
                            <u>Remove</u>
                        </span>
                    </div>
                    <div class="row col-md-12">
                        <mat-form-field style="float: left;">
                            <input type="number" min="0.01" matInput [ngModel]="account.debitAmount" (ngModelChange)="account.debitAmount=$event;handleAmountChange(transaction)" placeholder="Amount">
                        </mat-form-field>
                        <span *ngIf="j == transaction.debitAccounts.length-1" style="float: right;margin-top:20px; font-size: 13px; color: rgba(255, 152, 0, 1); cursor: pointer" (click)="addNewDebitAccount(i)">
                            <span class="material-icons" style="font-size: 13px;">control_point</span><span> &nbsp;Add Account</span>
                        </span>
                    </div>
                </div>

            </div>
            <div class="col-md-4">
                <div *ngFor="let account of transaction.creditAccounts; let j = index">
                    <div class="row col-md-12">
                        <mat-form-field style="width: 100%;">
                            <mat-select placeholder="Pay From" [ngModel]="account.creditAccount"  [disabled]="transaction.approvalId != null"
                                (ngModelChange)="account.creditAccount = $event">
                                <mat-option *ngFor="let account of accountsList"
                                    [value]="account">
                                    {{account.title}}&nbsp;A/c
                                </mat-option>   
                            </mat-select>
                        </mat-form-field>
                    </div>
                    <div class="row col-md-12" style="margin-top: -17px">
                        <span *ngIf="account.creditAccount != null" style="float: left; font-size: 11px; color:rgba(133, 133, 133, 1)">Current Balance - {{account.creditAccount.balance}}</span>
                        <span *ngIf="transaction.creditAccounts.length > 1" style="float: right; font-size: 13px; color: rgba(255, 152, 0, 1); cursor: pointer" (click)="removeCreditAccount(i, j); handleAmountChange(transaction)">
                            <u>Remove</u>
                        </span>

                    </div>
                    <div class="row col-md-12">
                        <mat-form-field style="float: left;">
                            <input type="number" min=0.01 matInput [ngModel]="account.creditAmount" (ngModelChange)="account.creditAmount=$event; handleAmountChange(transaction)" placeholder="Amount">
                        </mat-form-field>
                        <span *ngIf="j == transaction.creditAccounts.length-1" style="float: right; margin-top:20px;font-size: 13px; color: rgba(255, 152, 0, 1); cursor: pointer" (click)="addNewCreditAccount(i)">
                            <span class="material-icons" style="font-size: 13px;">control_point</span><span> &nbsp;Add Account</span>
                        </span>
                    </div>
                </div>
                
            </div>
            <div class="col-md-3" style="padding: 0px;">
                <div class="row col-md-12" style="margin-top: 20px;padding: 0px">
                    <span *ngIf="isAccountNotMentioned(transaction) == true" style="color: rgb(243, 59, 59); font-weight: 550">
                        <span class="material-icons" style="font-size: 15px;    vertical-align: -3px;">dangerous</span><span> &nbsp;Please Select An Account</span>
                    </span>
                </div>
                <div class="row col-md-12" style="margin-top: 5px;padding: 0px">
                    <span *ngIf="isAmountUnEqual(transaction) == true" style="color: rgb(243, 59, 59); font-weight: 550">
                        <span class="material-icons" style="font-size: 15px; vertical-align: -3px;">dangerous</span><span> &nbsp;Total Credit And Debit Amount Should Be Equal</span>
                    </span>
                </div>
                <div class="row col-md-12" style="margin-top: 5px;padding: 0px">
                    <span *ngIf="isAmountLessThanMinimum(transaction) == true" style="color: rgb(243, 59, 59); font-weight: 550">
                        <span class="material-icons" style="font-size: 15px; vertical-align: -3px;">dangerous</span><span> &nbsp;Minimum Amount should be 0.01</span>
                    </span>
                </div>
                <div class="row col-md-12" style="margin-top: 5px;padding: 0px">
                    <span *ngIf="isAccountRepeated(transaction) == true" style="color: rgb(243, 59, 59); font-weight: 550">
                        <span class="material-icons" style="font-size: 15px; vertical-align: -3px;">dangerous</span><span> &nbsp;Same Account Can Not Be Used In The Same Transaction</span>
                    </span>
                </div>
                <div class="row col-md-12" style="margin-top: 5px;padding: 0px">
                    <span *ngIf="isAmountMoreThanApproval(transaction) == true" style="color: rgb(243, 59, 59); font-weight: 550">
                        <span class="material-icons" style="font-size: 15px; vertical-align: -3px;">dangerous</span><span> &nbsp;Total Amount Can Not Be More Than Approved Amount</span>
                    </span>
                </div>
                <div class="row col-md-12" style="margin-top: 5px;padding: 0px">
                    <span *ngIf="isApprovalAttached(transaction) == true" style="color: rgb(243 170 3); font-weight: 550">
                        <span class="material-icons" style="font-size: 15px; vertical-align: -3px;">error_outline</span><span> &nbsp;Reapproval Request Can Not Be Generated</span>
                    </span>
                </div>
                <div class="row col-md-12" style="margin-top: 5px;padding: 0px">
                    <span *ngIf="isApprovalRequired(transaction) == true" style="color: rgb(243 170 3); font-weight: 550">
                        <span class="material-icons" style="font-size: 15px; vertical-align: -3px;">error_outline</span><span> &nbsp;Approval Is Required For This Transaction</span>
                    </span>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-1" style="width: 4%;"></div>
            <div class="col-md-4">
                <mat-form-field style="width: 100%;">
                    <input type="text" matInput [ngModel]="transaction.remark"
                        (ngModelChange)="transaction.remark=$event;" placeholder="Enter Remark"><br>
                </mat-form-field>
            </div>
            <div class="col-md-4">
                <mat-form-field >
                    <mat-select placeholder="Approval ID">
                        <mat-option *ngFor="let approval of approvalsList"  (click)="assignApproval(approval, transaction)"
                            [value]="approval">
                            {{approval.approvalId}}
                        </mat-option>   
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="col-md-3"></div>

        </div>
        <div class="row">
            <div class="col-md-1" style="width: 4%;"></div>
            <div class="col-md-4">
                <div class="row col-md-12 custom-font">Add Bill :</div>
                <input type='file' (click)="imageInput.value = null" (change)="readURL($event, transaction, 'bill');" multiple="false" style="display: none"
                            accept="image/jpeg,image/png" #imageInput />
                <div style="display: inline-block;">
                    <button type="submit" class="image-column" (click)="imageInput.click()"
                    style="cursor: pointer; font-size: 45px;color: rgb(0, 0, 0);border-radius: 2px; border-color:rgb(231, 228, 228); background-color: rgb(231, 228, 228);"
                    >+</button>
                </div>
                <div style="display: inline-block;" *ngFor="let image of transaction.billImages; let i = index">
                    <img src="{{image.imageURL}}" class="image-column" style="margin-top: -15px; cursor: pointer" (click)="openImagePreviewDialog(transaction.billImages, i, 1)">
                </div>
            </div>
            <div class="col-md-4">
                <div class="row col-md-12 custom-font">Add Quotation :</div>
                <input type='file' (click)="imageInput.value = null" (change)="readURL($event, transaction, 'quo');" multiple="false" style="display: none"
                            accept="image/jpeg,image/png" #imageInput1 />
                <div style="display: inline-block;">
                    <button type="submit" class="image-column" (click)="imageInput1.click()"
                    style="cursor: pointer; font-size: 45px;color: rgb(0, 0, 0);border-radius: 2px; border-color:rgb(231, 228, 228); background-color: rgb(231, 228, 228)"
                    >+</button>
                </div>
                <div style="display: inline-block;" *ngFor="let image of transaction.quotationImages; let i = index">
                    <img src="{{image.imageURL}}" class="image-column" style="margin-top: -15px; cursor: pointer" (click)="openImagePreviewDialog(transaction.quotationImages, i, 1)">
                </div>
            </div>
            <div class="col-md-3">
                <span *ngIf="transactions.length > 1"  style="float: right; margin-top:20px;font-size: 13px; color: rgba(255, 152, 0, 1); cursor: pointer" (click)="removeTransaction(i)">
                    <span class="material-icons" style="font-size: 13px;">remove_circle_outline</span><span> &nbsp;Delete</span>
                </span>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-1" style="width: 4%;"></div>
            <div class="col-md-10" style="border-bottom: 1px solid lightgrey; margin-top: 15px; margin-bottom: 15px;"></div>
            <div class="col-md-1" style="width: 4%;"></div>
        </div>

    </div>
    <div class="row col-md-12" style="margin-top: 10px">
        <mat-form-field>
            <input type="number" matInput [ngModel]="moreTransaction" (ngModelChange)="moreTransaction=$event;" placeholder="Add More Transactions">
        </mat-form-field>
        <span style="margin-top:20px;font-size: 13px; color: rgba(255, 152, 0, 1); cursor: pointer" (click)="addNewTransaction()">
            <span class="material-icons" style="font-size: 13px;">control_point</span><span> &nbsp;Add</span>
        </span>
    </div>
    <div class="row col-md-12" style="margin-top: 10px">
        <mat-checkbox [ngModel]="autoAdd" (ngModelChange)="autoAdd=$event">Add Transactions Once Approved</mat-checkbox>
    </div>
    <div class="row col-md-12" style="margin-top: 0px">
        <button type="submit" class="custom-button" *ngIf="!isApprovalButtonDisabled()" (click)="serviceAdapter.requestApprovals()">Request Approval</button>
        <button type="submit" style="color:  rgba(196, 196, 196, 1); cursor: not-allowed; border:2px solid rgba(196, 196, 196, 1); background: white" class="custom-button" *ngIf="isApprovalButtonDisabled()">Request Approval</button>
        <button type="submit" style="float: right;background:rgba(255, 152, 0, 1); color: white" class="custom-button" (click)="serviceAdapter.addTransactions()"  *ngIf="!isAddButtonDisabled()" >Add Transactions</button>
        <button type="submit" style="float: right;background:rgba(196, 196, 196, 1); color: white; cursor: not-allowed; border:2px solid rgba(196, 196, 196, 1);" class="custom-button" *ngIf="isAddButtonDisabled()" >Add Transactions</button>
    </div>
    </div>
    
</div>

<ng-container *ngIf="isLoading">
    <app-loading-spinner [user]="user"></app-loading-spinner>
</ng-container>
