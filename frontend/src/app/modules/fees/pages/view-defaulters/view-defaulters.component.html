<div class="card-content table-responsive">

    <ng-container *ngIf="!isLoading">
        <div class="row">
            <div class="col-sm-3">
                <div class="form-group form-black label-floating">
                    <label class="control-label">Min. No. (Fees Due till month)</label>
                    <input type="number"
                           class="form-control"
                           (keypress)="policeNumberInput($event)"
                           [ngModel]="minimumNumber"
                           (ngModelChange)="minimumNumber=$event;"/>
                </div>
            </div>
            <div class="col-sm-3">
                <div class="form-group form-black label-floating">
                    <label class="control-label">Max. No. (Fees Due till month)</label>
                    <input type="number"
                           class="form-control"
                           (keypress)="policeNumberInput($event)"
                           [ngModel]="maximumNumber"
                           (ngModelChange)="maximumNumber=$event;"/>
                </div>
            </div>
            <div class="col-sm-3" >
                <mat-form-field>
                    <mat-select placeholder="Select Filter Type"
                                [ngModel]="selectedFilterType"
                                (ngModelChange)="selectedFilterType=$event;">
                        <mat-option *ngFor='let filterType of filterTypeList;' [value]="filterType">
                            {{filterType}}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            <div class="col-sm-3" *ngIf="selectedFilterType==filterTypeList[0]">
                <div >
                    <mat-form-field>
                        <mat-select placeholder="Select Class"
                                    [ngModel]="selectedClassSection"
                                    (ngModelChange)="selectedClassSection=$event;">
                            <mat-option [value]="nullValue">All</mat-option>
                            <mat-option *ngFor='let classSection of filteredClassSectionList;' [value]="classSection">
                                {{classSection.class.name}}, {{classSection.section.name}}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
            </div>
        </div>

        <ng-container *ngIf="selectedFilterType==filterTypeList[0] && studentParameterList.length>0">
            <button class="btn"
                    style="padding: 4px 7px"
                    (click)="showCustomFilters=!showCustomFilters">
                <ng-container *ngIf="!showCustomFilters">Show Custom Filters</ng-container>
                <ng-container *ngIf="showCustomFilters">Hide Custom Filters</ng-container>
            </button><br/>
            <ng-container *ngIf="showCustomFilters">
                <ng-container *ngFor="let parameter of studentParameterList">
                    <mat-form-field>
                        <mat-label>{{parameter.name}}</mat-label>
                        <input matInput
                               type="text"
                               style="border: none"
                               [(ngModel)]="parameter.filterFilterValues">
                    </mat-form-field><br/>
                    <mat-checkbox [(ngModel)]="parameter.showNone"
                                  style="margin-right: 5px;"
                                  (click)="$event.stopPropagation();">None
                    </mat-checkbox>
                    <mat-checkbox *ngFor="let filter of getFilteredFilterValues(parameter)" [(ngModel)]="filter.show"
                                  style="margin-right: 5px;"
                                  (click)="$event.stopPropagation();">{{filter.name}}
                    </mat-checkbox><br/>
                </ng-container>
            </ng-container>
            <br/>
        </ng-container>

        <!-- print , download buttons -->
        <div class="row" >
            <div class="col-sm-3">
                <button type="button"
                        class="btn btn-{{user.activeSchool.secondaryThemeColor}}"
                        style="padding: 12px 15px; margin-right: 17px;"
                        matTooltip="Download the following list"
                        tooltip-position="left"
                        (click)="downloadFeesReport()">
                    Download<i class="material-icons" style="margin-left: 15px;">save_alt</i></button>
            </div>

            <div class="col-sm-3">
            <button type="button"
                    class="btn btn-{{user.activeSchool.secondaryThemeColor}} hidden-sm hidden-xs"
                    style="padding: 12px 15px; margin-right: 17px;"
                    matTooltip="Print the following list"
                    tooltip-position="left"
                    (click)="printFeesReport()">
                Print<i class="material-icons" style="margin-left: 15px;">print</i></button>
            </div>
        </div>

        <div class="row" style="margin-bottom: 15px; margin-top: 15px;">
            <div class="col-md-12"
                 style="border-bottom: 1px solid lightgrey;"></div>
        </div>

        <button class="btn"
                style="padding: 4px 7px"
                (click)="showSMSSection=!showSMSSection">
            <ng-container *ngIf="!showSMSSection">Show SMS Section</ng-container>
            <ng-container *ngIf="showSMSSection">Hide SMS Section</ng-container>
        </button>
        <ng-container *ngIf="showSMSSection">
            <div>SMS count: <b>{{smsBalance}}</b> <br /></div>
            <div class="row">
                <div class="col-sm-6">
                    <div class="form-group form-black label-floating">
                        <label class="control-label">Common Message to append</label>
                        <textarea type="text" rows="5"
                                  class="form-control"
                                  [(ngModel)]="extraDefaulterMessage"></textarea>
                    </div>
                </div>
                <div class="col-sm-3">
                    <mat-form-field style="margin-top: 23px;">
                        <mat-select placeholder="Send via" [(ngModel)]="selectedSentType">
                            <mat-option *ngFor='let sentType of sentTypeList;' [value]="sentType">
                                {{sentType}}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                    <div  style="font-size: 14px; margin-top: 5px;">
                        # of extra Characters/SMS: {{getExtraMessageLength()}}<br/>
                        # of Mobile devices: {{getNumberOfMobileDevice()}}<br/>
                        Estimated SMS Count: {{getEstimatedSMSCount()}}<br/>
                        Estimated Notification Count: {{getEstimatedNotificationCount()}}<br/>
                    </div>
                    <ng-container *ngIf="getEstimatedSMSCount()>0 || getEstimatedNotificationCount()>0">
                        <button *ngIf="getEstimatedSMSCount()<=smsBalance"
                                type="button"
                                class="btn btn-{{user.activeSchool.secondaryThemeColor}}"
                                style="padding: 12px 15px; margin-right: 17px;"
                                matTooltip="Notify all the selected defaulters"
                                tooltip-position="left"
                                (click)="notifyDefaulters();">
                            {{getButtonText()}}
                        </button>
                        <span *ngIf="getEstimatedSMSCount()>smsBalance"
                              style="font-size: 16px;">
                        You are short by <b>{{getEstimatedSMSCount() - smsBalance}}</b> SMS.
                    </span>
                    </ng-container>
                </div>
            </div>
        </ng-container>

        <div class="row" style="margin-bottom: 15px; margin-top: 15px;">
            <div class="col-md-12"
                 style="border-bottom: 1px solid lightgrey;"></div>
        </div>

        <!-- Parent -->

        <ng-container *ngIf="selectedFilterType==filterTypeList[1]">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        Selected: <b>{{getSelectedParentCount()}}</b>, Showing: <b>{{getFilteredParentList().length}}</b> out of {{parentList.length}} parents
                    </div>
                </div>
            </div>
            
            <div class="container-fluid" *ngIf="hasPermission()">
                <div *ngIf="!isMobile()" align="end">
                    
                    <div class="row">
                        <div class="col-sm-10">
                            Total Fees ({{getCurrentSessionName()}}) : 
                        </div>
                        <div class="col-sm-1" style="width: 10px;">
                            <b>Rs.</b>
                        </div>
                        <div class="col-sm-1" align="end" style="width: 120px;">
                            <b>{{totalFees | indianCurrency }}</b>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-sm-10">
                            Fees Paid ({{getCurrentSessionName()}}) : 
                        </div>
                        <div class="col-sm-1" style="width: 10px;">
                            <b>Rs.</b>
                        </div>
                        <div class="col-sm-1" align="end" style="width: 120px;">
                            <b>{{totalFeesPaid | indianCurrency }}</b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-10">
                            Total Fees Due (overall) : 
                        </div>
                        <div class="col-sm-1" style="width: 10px;">
                            <b>Rs.</b>
                        </div>
                        <div class="col-sm-1" align="end" style="width: 120px;">
                            <b>{{totalFeesDue | indianCurrency }}</b>
                        </div>
                    </div>
                    <div class="row" align="end">
                        <div class="col-sm-10">
                            Fees Due (Till Month): 
                        </div>
                        <div class="col-sm-1" style="width: 10px;">
                            <b>Rs.</b>
                        </div>
                        <div class="col-sm-1" align="end" style="width: 120px;">
                            <b>{{getFilteredParentListFeesDueTillMonth() | indianCurrency}}</b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-10">
                            Discount :
                        </div>
                        <div class="col-sm-1" style="width: 10px;">
                            <b>Rs.</b>
                        </div>
                        <div class="col-sm-1" align="end" style="width: 120px;">
                            <b>{{totalDiscount | indianCurrency}}</b>
                        </div>
                    </div>
                </div>
            </div>
            
            <div *ngIf="isMobile() && hasPermission()" style="margin-top: 20px;">
                <div class="container-fluid">
                    
                    <div class="row">
                        <div class="col-xs-7 ">
                            Total Fees ({{getCurrentSessionName()}}) : 
                        </div>
                        <div class="col-xs-2 ">
                            <b>Rs.</b>
                        </div>
                        <div style="text-align: right;">
                            <b>{{totalFees | indianCurrency }}</b>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-xs-7 ">
                            Fees Paid ({{getCurrentSessionName()}}) : 
                        </div>
                        <div class="col-xs-2 ">
                            <b>Rs.</b>
                        </div>
                        <div style="text-align: right;">
                            <b>{{totalFeesPaid | indianCurrency }}</b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-7 ">
                            Total Fees Due (overall) : 
                        </div>
                        <div class="col-xs-2 ">
                            <b>Rs.</b>
                        </div>
                        <div style="text-align: right;">
                            <b>{{totalFeesDue | indianCurrency }}</b>
                        </div>
                    </div>
                    <div class="row"> 
                        <div class="col-xs-7 ">
                            Fees Due (Till Month): 
                        </div>
                        <div class="col-xs-2 ">
                            <b>Rs.</b>
                        </div>
                        <div style="text-align: right;">
                            <b>{{getFilteredParentListFeesDueTillMonth() | indianCurrency}}</b>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-7 ">
                            Discount :
                        </div>
                        <div class="col-xs-2 ">
                            <b>Rs.</b>
                        </div>
                        <div style="text-align: right;">
                            <b>{{totalDiscount | indianCurrency}}</b>
                        </div>
                    </div>
                </div>
                
            </div>
            <div class="row">
                <div class="col-sm-12">
                    <button class="btn"
                            style="padding: 4px 7px"
                            (click)="selectAllHandler(); $event.stopPropagation();">Select All
                    </button>
                    <button class="btn"
                            style="padding: 4px 7px"
                            (click)="clearAllHandler(); $event.stopPropagation();">Clear All
                    </button>
                </div>
            </div>

            <table class="table table-hover">
                <thead class="text-{{user.activeSchool.secondaryThemeColor}}">
                <tr>
                    <th></th>
                    <th>S No.</th>
                    <th>Parent</th>
                    <th>Student</th>
                    <th>Class</th>
                    <th>Mobile No.</th>
                    <th>Mobile No. (2)</th>
                    <th>Fees Due<br/>(Till Month)</th>
                    <th>Fees Due<br/>(Overall)</th>
                    <th>Total Fees<br/>({{getCurrentSessionName()}})</th>
                    <th>Fees Paid<br/>({{getCurrentSessionName()}})</th>
                    <th>Discount<br/>({{getCurrentSessionName()}})</th>
                </tr>
                </thead>
                <tbody>
                <ng-container *ngFor="let parent of getFilteredParentList(); let i=index;">
                    <tr>
                        <td>
                            <mat-checkbox [(ngModel)]="parent.selected"></mat-checkbox>
                        </td>
                        <td>{{i+1}}.</td>
                        <td style="font-weight: 600;">{{parent.name}}</td>
                        <ng-container *ngIf="parent.studentList.length == 1; else multipleStudents">
                            <td>{{parent.studentList[0].name}}</td>
                            <td>{{parent.studentList[0].class.name}}, {{parent.studentList[0].section.name}}</td>
                            <td>
                                <ng-container *ngIf="checkMobileNumber(parent.studentList[0].mobileNumber)">
                                    <span class="hidden-xs hidden-sm">{{parent.studentList[0].mobileNumber}}</span>
                                    <span class="visible-xs visible-sm">
                                        <a href="tel:{{parent.studentList[0].mobileNumber}}">Call Me</a>
                                    </span>
                                </ng-container>
                            </td>
                            <td>
                                <ng-container *ngIf="checkMobileNumber(parent.studentList[0].secondMobileNumber)">
                                    <span class="hidden-xs hidden-sm">{{parent.studentList[0].secondMobileNumber}}</span>
                                    <span class="visible-xs visible-sm">
                                        <a href="tel:{{parent.studentList[0].secondMobileNumber}}">Call Me</a>
                                    </span>
                                </ng-container>
                            </td>
                        </ng-container>
                        <ng-template #multipleStudents>
                            <td></td>
                            <td></td>
                            <td>
                                <ng-container *ngIf="checkMobileNumber(parent.studentList[0].mobileNumber)">
                                    <span class="hidden-xs hidden-sm">{{parent.studentList[0].mobileNumber}}</span>
                                    <span class="visible-xs visible-sm">
                                        <a href="tel:{{parent.studentList[0].mobileNumber}}">Call Me</a>
                                    </span>
                                </ng-container>
                            </td>
                            <td></td>
                        </ng-template>
                        <td style="font-weight: 600;">{{getParentFeesDueTillMonth(parent) | indianCurrency}}</td>
                        <td>{{getParentFeesDueOverall(parent) | indianCurrency}}</td>
                        <td>{{getParentTotalFees(parent) | indianCurrency}}</td>
                        <td>{{getParentFeesPaid(parent) | indianCurrency}}</td>
                        <td>{{getParentDiscount(parent) | indianCurrency}}</td>
                    </tr>
                    <ng-container *ngIf="parent.studentList.length > 1">
                        <ng-container *ngFor="let student of parent.studentList;">
                            <tr>
                                <td></td>
                                <td></td>
                                <td></td>
                                <td>{{student.name}}</td>
                                <td>{{student.class.name}}, {{student.section.name}}</td>
                                <td></td>
                                <td>
                                    <ng-container *ngIf="checkMobileNumber(student.secondMobileNumber)">
                                        <span class="hidden-xs hidden-sm">{{student.secondMobileNumber}}</span>
                                        <span class="visible-xs visible-sm">
                                            <a href="tel:{{student.secondMobileNumber}}">Call Me 2</a>
                                        </span>
                                    </ng-container>
                                </td>
                                <td>{{student.feesDueTillMonth | indianCurrency}}</td>
                                <td>{{student.feesDueOverall | indianCurrency}}</td>
                                <td>{{student.totalFeesThisSession | indianCurrency}}</td>
                                <td>{{student.feesPaidThisSession | indianCurrency}}</td>
                                <td>{{student.discountThisSession | indianCurrency}}</td>
                            </tr>
                        </ng-container>
                    </ng-container>
                </ng-container>
                </tbody>
            </table>

        </ng-container>

        <!-- Student -->

        <ng-container *ngIf="selectedFilterType==filterTypeList[0]">

            <div class="container-fluid">
                <div class="row">
                    <div class="col-sm-12">
                        Selected:  <b>{{getSelectedChildrenCount()}}</b>, Showing: <b>{{getFilteredStudentList().length}}</b> out of {{studentList.length}} students
                    </div>
                </div>
            </div>
            
                <div class="container-fluid" *ngIf="hasPermission()">
                    <div *ngIf="!isMobile()" align="end">
                        
                        <div class="row">
                            <div class="col-sm-10">
                                Total Fees ({{getCurrentSessionName()}}) : 
                            </div>
                            <div class="col-sm-1" style="width: 10px;">
                                <b>Rs.</b>
                            </div>
                            <div class="col-sm-1" align="end" style="width: 120px;">
                                <b>{{totalFees | indianCurrency }}</b>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-sm-10">
                                Fees Paid ({{getCurrentSessionName()}}) : 
                            </div>
                            <div class="col-sm-1" style="width: 10px;">
                                <b>Rs.</b>
                            </div>
                            <div class="col-sm-1" align="end" style="width: 120px;">
                                <b>{{totalFeesPaid | indianCurrency }}</b>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-10">
                                Total Fees Due (overall) : 
                            </div>
                            <div class="col-sm-1" style="width: 10px;">
                                <b>Rs.</b>
                            </div>
                            <div class="col-sm-1" align="end" style="width: 120px;">
                                <b>{{totalFeesDue | indianCurrency }}</b>
                            </div>
                        </div>
                        <div class="row" align="end">
                            <div class="col-sm-10">
                                Fees Due (Till Month): 
                            </div>
                            <div class="col-sm-1" style="width: 10px;">
                                <b>Rs.</b>
                            </div>
                            <div class="col-sm-1" align="end" style="width: 120px;">
                                <b>{{getFilteredParentListFeesDueTillMonth() | indianCurrency}}</b>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-10">
                                Discount :
                            </div>
                            <div class="col-sm-1" style="width: 10px;">
                                <b>Rs.</b>
                            </div>
                            <div class="col-sm-1" align="end" style="width: 120px;">
                                <b>{{totalDiscount | indianCurrency}}</b>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div *ngIf="isMobile() && hasPermission()" style="margin-top: 20px;">
                    <div class="container-fluid">
                        
                        <div class="row">
                            <div class="col-xs-7 ">
                                Total Fees ({{getCurrentSessionName()}}) : 
                            </div>
                            <div class="col-xs-2 ">
                                <b>Rs.</b>
                            </div>
                            <div style="text-align: right;">
                                <b>{{totalFees | indianCurrency }}</b>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-xs-7 ">
                                Fees Paid ({{getCurrentSessionName()}}) : 
                            </div>
                            <div class="col-xs-2 ">
                                <b>Rs.</b>
                            </div>
                            <div style="text-align: right;">
                                <b>{{totalFeesPaid | indianCurrency }}</b>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-7 ">
                                Total Fees Due (overall) : 
                            </div>
                            <div class="col-xs-2 ">
                                <b>Rs.</b>
                            </div>
                            <div style="text-align: right;">
                                <b>{{totalFeesDue | indianCurrency }}</b>
                            </div>
                        </div>
                        <div class="row"> 
                            <div class="col-xs-7 ">
                                Fees Due (Till Month): 
                            </div>
                            <div class="col-xs-2 ">
                                <b>Rs.</b>
                            </div>
                            <div style="text-align: right;">
                                <b>{{getFilteredParentListFeesDueTillMonth() | indianCurrency}}</b>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-xs-7 ">
                                Discount :
                            </div>
                            <div class="col-xs-2 ">
                                <b>Rs.</b>
                            </div>
                            <div style="text-align: right;">
                                <b>{{totalDiscount | indianCurrency}}</b>
                            </div>
                        </div>
                    </div>
                    
                </div>
            
            <div class="row">
                <div class="col-sm-12">
                    <button class="btn"
                            style="padding: 4px 7px"
                            (click)="selectAllHandler(); $event.stopPropagation();">Select All
                    </button>
                    <button class="btn"
                            style="padding: 4px 7px"
                            (click)="clearAllHandler(); $event.stopPropagation();">Clear All
                    </button>
                </div>
            </div>

            <table class="table table-hover">
                <thead class="text-{{user.activeSchool.secondaryThemeColor}}">
                <tr>
                    <th></th>
                    <th>S No.</th>
                    <th>Student</th>
                    <th>Father</th>
                    <th>Class</th>
                    <th>Mobile No.</th>
                    <th>Mobile No. (2)</th>
                    <th>Fees Due<br/>(Till Month)</th>
                    <th>Fees Due<br/>(Overall)</th>
                    <th>Total Fees<br/>({{getCurrentSessionName()}})</th>
                    <th>Fees Paid<br/>({{getCurrentSessionName()}})</th>
                    <th>Discount<br/>({{getCurrentSessionName()}})</th>
                </tr>
                </thead>
                <tbody>
                <ng-container *ngFor="let student of getFilteredStudentList(); let i=index;">
                    <tr>
                        <td><mat-checkbox [(ngModel)]="student.selected"></mat-checkbox></td>
                        <td>{{i+1}}.</td>
                        <td style="font-weight: 600;">{{student.name}}</td>
                        <td>{{student.fathersName}}</td>
                        <td>{{student.class.name}}, {{student.section.name}}</td>
                        <td>
                            <ng-container *ngIf="checkMobileNumber(student.mobileNumber)">
                                <span class="hidden-xs hidden-sm">{{student.mobileNumber}}</span>
                                <span class="visible-xs visible-sm">
                                    <a href="tel:{{student.mobileNumber}}">Call Me</a>
                                </span>
                            </ng-container>
                        </td>
                        <td>
                            <ng-container *ngIf="checkMobileNumber(student.secondMobileNumber)">
                                <span class="hidden-xs hidden-sm">{{student.secondMobileNumber}}</span>
                                <span class="visible-xs visible-sm">
                                    <a href="tel:{{student.secondMobileNumber}}">Call Me 2</a>
                                </span>
                            </ng-container>
                        </td>
                        <td style="font-weight: 600;">{{student.feesDueTillMonth | indianCurrency}}</td>
                        <td>{{student.feesDueOverall | indianCurrency}}</td>
                        <td>{{student.totalFeesThisSession | indianCurrency}}</td>
                        <td>{{student.feesPaidThisSession | indianCurrency}}</td>
                        <td>{{student.discountThisSession | indianCurrency}}</td>
                    </tr>
                </ng-container>
                </tbody>
            </table>

        </ng-container>

    </ng-container>

    <ng-container *ngIf="isLoading">
        <app-loading-spinner [user]="user" [timer]="60"></app-loading-spinner>
    </ng-container>

</div>
